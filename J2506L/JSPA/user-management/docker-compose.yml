services:
  mysql:
    image: mysql:9.6.0
    container_name: mysql-user-management
    restart: always

    environment:
      MYSQL_ROOT_PASSWORD: Abc123456789
      MYSQL_DATABASE: user_management
    command:
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci  
    ports:
      - "3309:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s #ðŸ‘‰ Cá»© 10 giÃ¢y Docker cháº¡y healthcheck 1 láº§n
      timeout: 5s #Náº¿u lá»‡nh healthcheck cháº¡y quÃ¡ 5 giÃ¢y â†’ Docker coi lÃ  FAILED
      retries: 5 #Náº¿u 5 láº§n liÃªn tiáº¿p FAILED â†’ Container bá»‹ Ä‘Ã¡nh dáº¥u UNHEALTHY
      start_period: 30s #Trong 30 giÃ¢y Ä‘áº§u: DÃ¹ healthcheck FAIL, Docker KHÃ”NG tÃ­nh lÃ  lá»—i
    volumes:
      - mysql_user_management:/var/lib/mysql    
  spring-app:
    build:
      context: .
      dockerfile: Dockerfile
    #image: sunlight4d/user-management:latest #khi nÃ o build CI/CD thÃ¬ nhá»› báº­t dÃ²ng nÃ y lÃªn vÃ  xÃ³a "build" Ä‘i
    container_name: user-management-app
    restart: always
    depends_on:
      mysql:
        condition: service_healthy

    ports:
      - "7080:8080"

    environment:
      SERVER_PORT: ${SERVER_PORT}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}


volumes:
  mysql_user_management:
#Cháº¡y thá»­ intelliJ, chá»‰ cáº§n báº­t mysql service:
#docker compose -f docker-compose.yml up -d --build mysql

#Khi cáº§n cháº¡y toÃ n bá»™(spring_app + mysql) trÃªn Docker má»›i cáº§n:
#docker compose --env-file .env.docker -f docker-compose.yml up -d --build

#docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Ports}}"